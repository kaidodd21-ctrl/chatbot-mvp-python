<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kai • Virtual Assistant</title>
<style>
  :root{
    --brand:#2e9153;
    --brand-dark:#267945;
    --page:#f5f7fb;
    --card:#ffffff;
    --muted:#6b7280;
    --border:#eef0f4;
    --bot:#eef2f3;
    --user:#2e9153;
    --text:#111827;
    --shadow1:0 20px 50px rgba(24,39,75,.12), 0 10px 20px rgba(24,39,75,.08);
    --chip:#ffffff;
    --chip-border:#e5e7eb;
  }

  body{
    margin:0; background:var(--page); color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;
    display:flex; align-items:center; justify-content:center; min-height:100vh; padding:18px;
  }
  .card{ width:100%; max-width:860px; height:min(92vh,820px); background:var(--card); border-radius:16px;
    box-shadow:var(--shadow1); display:flex; overflow:hidden; border:1px solid var(--border);}
  .chat{ flex:1; display:flex; flex-direction:column; height:100%;}
  .header{display:flex; align-items:center; gap:12px; padding:14px 18px; border-bottom:1px solid var(--border);}
  .avatar{width:36px; height:36px; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:600; background:var(--brand);}
  .title{font-weight:700}
  .subtitle{font-size:12px; color:var(--muted)}
  .spacer{flex:1}
  .lang-select{padding:4px 6px; border-radius:6px; border:1px solid var(--border); background:#fff; font-size:13px;}

  #chat-box{flex:1; overflow:auto; padding:18px;}
  .row{display:flex; gap:10px; margin:12px 0;}
  .row.bot{justify-content:flex-start}
  .row.user{justify-content:flex-end}
  .bubble{max-width:70%; padding:12px 14px; border-radius:18px; line-height:1.35; font-size:15px;}
  .bot .bubble{background:var(--bot); color:var(--text); display:flex; align-items:center; gap:6px;}
  .user .bubble{background:var(--user); color:#fff;}

  .flag{font-size:14px;} /* flag in bot messages */
  .typing .dot{ animation: blink 1.2s infinite ease-in-out; opacity:0.25;}
  .typing .dot:nth-child(1){ animation-delay:0s }
  .typing .dot:nth-child(2){ animation-delay:0.2s }
  .typing .dot:nth-child(3){ animation-delay:0.4s }
  @keyframes blink { 0%,80%,100%{opacity:0.25;} 40%{opacity:1;} }

  #suggestions{display:flex; flex-wrap:wrap; gap:8px; padding:8px 18px 0 18px;}
  #suggestions button{background:var(--chip); border:1px solid var(--chip-border); padding:7px 12px; border-radius:999px; cursor:pointer;}
  .input{padding:12px; display:flex; gap:10px; border-top:1px solid var(--border);}
  #user-input{flex:1; padding:12px 14px; border:1px solid var(--chip-border); border-radius:12px;}
  #send-btn{padding:12px 18px; background:var(--brand); color:#fff; border:none; border-radius:12px; cursor:pointer; font-weight:600;}
  #send-btn:hover{background:var(--brand-dark)}
</style>
</head>
<body>
  <div class="card">
    <div class="chat">
      <div class="header">
        <div class="avatar">K</div>
        <div>
          <div class="title">Kai • Virtual Assistant</div>
          <div class="subtitle">
            Glyns’s Salon — <span id="status">Online now</span> • 
            <span id="current-lang">🇬🇧 EN</span>
          </div>
        </div>
        <div class="spacer"></div>
        <select id="lang-select" class="lang-select">
          <option value="en">🇬🇧 EN</option>
          <option value="fr">🇫🇷 FR</option>
          <option value="es">🇪🇸 ES</option>
        </select>
      </div>

      <div id="chat-box"></div>
      <div id="suggestions"></div>

      <div class="input">
        <input id="user-input" type="text" placeholder="Type your message…" />
        <button id="send-btn">Send</button>
        <button id="reset-btn">New Chat</button>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://chatbot-mvp-python.onrender.com/chat";
  const chatBox = document.getElementById("chat-box");
  const input = document.getElementById("user-input");
  const langSelect = document.getElementById("lang-select");
  const currentLangEl = document.getElementById("current-lang");
  const SESSION_KEY = "chat_session_id";
  const LANG_KEY = "chat_language";

  let SESSION_ID = localStorage.getItem(SESSION_KEY) || ("sess_" + Math.random().toString(36).substr(2,9));
  localStorage.setItem(SESSION_KEY, SESSION_ID);

  if(localStorage.getItem(LANG_KEY)){
    langSelect.value = localStorage.getItem(LANG_KEY);
    updateCurrentLang(langSelect.value);
  }

  langSelect.addEventListener("change", ()=>{
    localStorage.setItem(LANG_KEY, langSelect.value);
    updateCurrentLang(langSelect.value);
    addMessage("🔄 Language switched to " + langSelect.options[langSelect.selectedIndex].text,"bot",langSelect.value);
  });

  function flagForLang(lang){
    if(lang==="fr") return "🇫🇷 FR";
    if(lang==="es") return "🇪🇸 ES";
    return "🇬🇧 EN";
  }

  function updateCurrentLang(lang){
    currentLangEl.textContent = flagForLang(lang);
  }

  function addMessage(text,sender,lang="en"){
    const row=document.createElement("div");
    row.className="row "+sender;
    const bubble=document.createElement("div");
    bubble.className="bubble";
    if(sender==="bot"){
      const flag=document.createElement("span");
      flag.className="flag";
      flag.textContent=flagForLang(lang).split(" ")[0]; // just flag
      bubble.appendChild(flag);
    }
    const msg=document.createElement("span");
    msg.innerHTML=text;
    bubble.appendChild(msg);
    row.appendChild(bubble);
    chatBox.appendChild(row);
    chatBox.scrollTop=chatBox.scrollHeight;
  }

  function renderSuggestions(suggest=[]){
    const box=document.getElementById("suggestions");
    box.innerHTML="";
    (suggest||[]).forEach(txt=>{
      const b=document.createElement("button");
      b.textContent=txt;
      b.onclick=()=>{input.value=txt; sendMessage();};
      box.appendChild(b);
    });
  }

  // Typing + filler
  let typingEl=null;
  let fillerTimeout=null;

  function showTyping(){
    if(typingEl) return;
    typingEl=document.createElement("div");
    typingEl.className="row bot typing";
    typingEl.innerHTML=`<div class="bubble">Kai is typing <span class="dot">.</span><span class="dot">.</span><span class="dot">.</span></div>`;
    chatBox.appendChild(typingEl);
    chatBox.scrollTop=chatBox.scrollHeight;

    // After 5s show filler
    fillerTimeout=setTimeout(()=>{
      if(typingEl){
        typingEl.querySelector(".bubble").textContent="⏳ Still checking, please hold…";
      }
    },5000);
  }

  function hideTyping(){
    if(typingEl){ typingEl.remove(); typingEl=null; }
    if(fillerTimeout){ clearTimeout(fillerTimeout); fillerTimeout=null; }
  }

  async function sendMessage(textOverride=null){
    const text=textOverride!==null?textOverride:input.value.trim();
    if(!text && textOverride===null) return;
    if(text) addMessage(text,"user");
    input.value=""; input.focus();

    // show typing right away
    showTyping();

    try{
      const res=await fetch(API_URL+"?session_id="+SESSION_ID,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({message:text, language:langSelect.value})
      });
      const data=await res.json();

      hideTyping();

      if(data.reply) addMessage(data.reply,"bot",data.language||langSelect.value);
      renderSuggestions(data.suggest||[]);
      if(data.language){
        langSelect.value=data.language;
        localStorage.setItem(LANG_KEY,data.language);
        updateCurrentLang(data.language);
      }
    }catch(e){
      hideTyping();
      addMessage("⚠️ Could not reach server.","bot");
    }
  }

  document.getElementById("send-btn").addEventListener("click",()=>sendMessage());
  input.addEventListener("keydown",e=>{if(e.key==="Enter")sendMessage();});
  document.getElementById("reset-btn").addEventListener("click",()=>{
    localStorage.removeItem(SESSION_KEY);
    localStorage.removeItem("chat_history");
    location.reload();
  });

  window.addEventListener("load",()=>{ sendMessage(""); });
</script>
</body>
</html>
