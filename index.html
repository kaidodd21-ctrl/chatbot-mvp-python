<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Kai â€¢ Virtual Assistant</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div id="chat-container">
    <header>
      <h2>Kai â€¢ Virtual Assistant</h2>
      <div id="status" class="status checking"><span class="dot"></span> Checking...</div>
      <button onclick="restartChat()">âŸ³ Restart</button>
    </header>

    <div id="chat-box"></div>

    <div id="input-container">
      <input id="user-input" type="text" placeholder="Type a message..." onkeydown="if(event.key==='Enter'){handleSend()}" />
      <button onclick="handleSend()">Send</button>
    </div>
  </div>

  <script>
  // ------------------------------
  // Backend URL (Render)
  // ------------------------------
  const API_BASE = "https://chatbot-mvp-python.onrender.com";
  const BACKEND_URL = API_BASE + "/chat";

  let sessionId = null;

  // ------------------------------
  // Status Handling
  // ------------------------------
  function setStatus(state, text) {
    const statusEl = document.getElementById("status");
    statusEl.className = `status ${state}`;
    statusEl.innerHTML = `<span class="dot"></span> ${text}`;
  }

  async function checkBackend() {
    setStatus("checking", "Checking...");
    try {
      const res = await fetch(API_BASE + "/health");
      if (res.ok) {
        setStatus("online", "Connected âœ…");
      } else {
        setStatus("offline", "Disconnected âŒ");
      }
    } catch {
      setStatus("offline", "Disconnected âŒ");
    }
  }

  setInterval(checkBackend, 15000); // every 15s
  window.onload = () => {
    checkBackend();
    restartChat();
  };

  // ------------------------------
  // Message Helpers
  // ------------------------------
  function addUserMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msgWrapper = document.createElement("div");
    msgWrapper.className = "message user";
    const statusId = "status-" + Date.now();

    msgWrapper.innerHTML = `
      <div class="avatar"></div>
      <div class="bubble">${escapeHtml(text)}</div>
      <div class="status" id="${statusId}">âœ“ Sent</div>
    `;

    chatBox.appendChild(msgWrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
    return document.getElementById(statusId);
  }

  function addBotMessage(text) {
    const chatBox = document.getElementById("chat-box");
    const msgWrapper = document.createElement("div");
    msgWrapper.className = "message bot";
    msgWrapper.innerHTML = `
      <div class="avatar"></div>
      <div class="bubble">${renderMarkdownish(text)}</div>
    `;
    chatBox.appendChild(msgWrapper);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function addSuggestions(suggestions) {
    const chatBox = document.getElementById("chat-box");
    const suggBox = document.createElement("div");
    suggBox.className = "suggestions";

    suggestions.forEach((s, i) => {
      const btn = document.createElement("button");
      btn.innerText = s;
      btn.onclick = () => sendMessage(s);
      btn.style.animationDelay = `${0.1 + i * 0.15}s`;
      suggBox.appendChild(btn);
    });

    chatBox.appendChild(suggBox);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function showTyping() {
    const chatBox = document.getElementById("chat-box");
    const typingDiv = document.createElement("div");
    typingDiv.id = "typing";
    typingDiv.className = "message bot";
    typingDiv.innerHTML = `
      <div class="avatar"></div>
      <div class="bubble typing">
        <span class="dot"></span><span class="dot"></span><span class="dot"></span>
      </div>`;
    chatBox.appendChild(typingDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function hideTyping() {
    const typingDiv = document.getElementById("typing");
    if (typingDiv) typingDiv.remove();
  }

  // ------------------------------
  // Send + Handle Messages
  // ------------------------------
  async function sendMessage(text) {
    const statusEl = addUserMessage(text);
    setTimeout(() => statusEl.innerText = "âœ“âœ“ Delivered", 400);

    document.getElementById("user-input").value = "";
    showTyping();

    try {
      const res = await fetch(BACKEND_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, session_id: sessionId })
      });

      const data = await res.json();
      sessionId = data.session_id;

      // delay bot reply by ~1 second
      setTimeout(() => {
        hideTyping();
        addBotMessage(data.reply);

        if (data.suggestions && data.suggestions.length > 0) {
          setTimeout(() => addSuggestions(data.suggestions), 400);
        }
        statusEl.innerText = "âœ“âœ“ Read"; // turn into blue double ticks
        statusEl.style.color = "#1DA1F2"; // WhatsApp-style blue
      }, 1000);
    } catch (error) {
      hideTyping();
      addBotMessage("âš ï¸ Oops, I couldnâ€™t connect to the server. Please try again.");
      statusEl.innerText = "Failed";
    }
  }

  function handleSend() {
    const input = document.getElementById("user-input").value.trim();
    if (input) sendMessage(input);
  }

  function restartChat() {
    document.getElementById("chat-box").innerHTML = "";
    sessionId = null;
    addBotMessage("Hi ðŸ‘‹ Iâ€™m Kai, your assistant. How can I help today?");
    setTimeout(() => addSuggestions(["Make a booking", "Opening hours", "Contact details"]), 400);
  }

  // ------------------------------
  // Small helpers
  // ------------------------------
  function escapeHtml(str) {
    return str.replace(/[&<>"']/g, (m) => ({
      "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;"
    }[m]));
  }
  function renderMarkdownish(str) {
    return escapeHtml(str).replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>").replace(/\n/g,"<br/>");
  }
  </script>
</body>
</html>
