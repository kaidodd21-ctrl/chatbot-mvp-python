<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kai • Virtual Assistant</title>
<style>
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f5f7fb;}
.card{width:100%;max-width:860px;height:min(92vh,820px);background:#fff;border-radius:16px;display:flex;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);}
.chat{flex:1;display:flex;flex-direction:column;}
.header{padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px;}
.avatar{width:36px;height:36px;border-radius:50%;overflow:hidden;}
.avatar img{width:100%;height:100%;object-fit:cover;}
.status{font-size:12px;color:#28a745;display:flex;align-items:center;gap:4px;}
#chat-box{flex:1;overflow-y:auto;padding:16px;}
.row{margin:10px 0;clear:both;}
.bubble{padding:10px 14px;border-radius:16px;max-width:70%;display:inline-block;position:relative;font-size:15px;line-height:1.4;}
.user .bubble{background:#2e9153;color:#fff;float:right;}
.bot .bubble{background:#eef2f3;color:#111;float:left;}
#suggestions{padding:8px;display:flex;flex-wrap:wrap;gap:8px;}
#suggestions button{border:1px solid #ccc;background:#fff;border-radius:16px;padding:6px 12px;cursor:pointer;}
.input{padding:12px;border-top:1px solid #eee;display:flex;gap:8px;}
#user-input{flex:1;padding:10px;border:1px solid #ccc;border-radius:12px;font-size:15px;}
#send-btn{background:#2e9153;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer;}
.side{width:240px;border-left:1px solid #eee;padding:12px;display:flex;flex-direction:column;}
.pill{display:inline-block;padding:6px 10px;background:#eef2f3;border-radius:16px;margin:4px 0;cursor:pointer;}
#reset-btn{margin-top:auto;background:#2e9153;color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer;}
.escalate-btns{margin-top:8px;}
.escalate-btns button{margin:4px 4px 0 0;padding:6px 12px;border:none;border-radius:8px;cursor:pointer;}
.call-btn{background:#2e9153;color:#fff;}
.email-btn{background:#007bff;color:#fff;}
.human-btn{background:#ff9800;color:#fff;}
</style>
</head>
<body>
<div class="card">
  <div class="chat">
    <div class="header">
      <div class="avatar"><img src="https://i.pravatar.cc/100?u=kai" alt="Kai"></div>
      <div>
        <div class="title">Kai • Virtual Assistant</div>
        <div class="status">🟢 Online now</div>
      </div>
    </div>
    <div id="chat-box"></div>
    <div id="suggestions"></div>
    <div class="input">
      <input id="user-input" type="text" placeholder="Type your message…" />
      <button id="send-btn">Send</button>
    </div>
  </div>
  <aside class="side">
    <h4>Need something quick?</h4>
    <div id="sidebar-pills"></div>
    <button id="reset-btn">🔄 Start New Chat</button>
  </aside>
</div>

<script>
const API_URL = "https://chatbot-mvp-python.onrender.com/chat";
let SESSION_ID = localStorage.getItem("chat_session_id") || "web-" + Math.random().toString(36).slice(2,10);
localStorage.setItem("chat_session_id", SESSION_ID);

const chatBox=document.getElementById("chat-box");

function addMessage(text,sender){
  const row=document.createElement("div");row.className="row "+sender;
  const bubble=document.createElement("div");bubble.className="bubble";bubble.innerHTML=text;
  row.appendChild(bubble);chatBox.appendChild(row);
  chatBox.scrollTop=chatBox.scrollHeight;
}
function renderSuggestions(suggest=[]){
  const box=document.getElementById("suggestions");box.innerHTML="";
  suggest.forEach(txt=>{
    const b=document.createElement("button");b.textContent=txt;
    b.onclick=()=>{document.getElementById("user-input").value=txt;sendMessage();};
    box.appendChild(b);
  });
}
function renderSidebar(pills=[]){
  const pillBox=document.getElementById("sidebar-pills");pillBox.innerHTML="";
  (pills||[]).forEach(txt=>{
    const pill=document.createElement("span");pill.className="pill";pill.textContent=txt;
    pill.onclick=()=>{document.getElementById("user-input").value=txt;sendMessage();};
    pillBox.appendChild(pill);
  });
}

async function sendMessage(){
  const input=document.getElementById("user-input");
  const text=input.value.trim();
  if(!text) return;
  addMessage(text,"user");

  // ✅ force clear + keep focus
  input.value = "";
  input.focus();

  try{
    const res=await fetch(API_URL+"?session_id="+SESSION_ID,{
      method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({message:text})
    });
    const data=await res.json();
    console.log("Backend response:",data);
    if(data.reply) addMessage(data.reply,"bot");
    if(data.suggest) renderSuggestions(data.suggest);
    if(data.sidebar) renderSidebar(data.sidebar);
    if(data.escalate){
      const esc=document.createElement("div");
      esc.className="escalate-btns";
      esc.innerHTML=`<button class="call-btn" onclick="window.location.href='tel:08007779999'">📞 Call us</button>
                     <button class="email-btn" onclick="window.location.href='mailto:kmd@kai.com'">📧 Email us</button>
                     <button class="human-btn">👤 Human support</button>`;
      chatBox.appendChild(esc);
    }
  }catch(err){
    console.error("Chat error:",err);
    addMessage("⚠️ Could not reach the server.","bot");
  }
}

document.getElementById("send-btn").addEventListener("click",sendMessage);
document.getElementById("user-input").addEventListener("keydown",e=>{if(e.key==="Enter")sendMessage();});

// Intro message from backend
window.addEventListener("load",()=>{
  fetch(API_URL+"?session_id="+SESSION_ID,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:""})})
    .then(r=>r.json()).then(data=>{
      console.log("Intro response:",data);
      if(data.reply) addMessage(data.reply,"bot");
      if(data.suggest) renderSuggestions(data.suggest);
      if(data.sidebar) renderSidebar(data.sidebar);
    });
});

// Reset chat
document.getElementById("reset-btn").addEventListener("click",()=>{
  localStorage.removeItem("chat_session_id");
  localStorage.removeItem("chat_history");
  location.reload();
});
</script>
</body>
</html>
