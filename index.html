<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kai • Virtual Assistant</title>
<style>
body{margin:0;font-family:Arial,sans-serif;display:flex;justify-content:center;align-items:center;min-height:100vh;background:#f5f7fb;}
.card{width:100%;max-width:860px;height:min(92vh,820px);background:#fff;border-radius:16px;display:flex;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.1);}
.chat{flex:1;display:flex;flex-direction:column;}
.header{padding:12px 16px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:8px;}
.avatar{width:36px;height:36px;border-radius:50%;background:#2e9153;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:bold;}
.title{font-weight:bold;}
.subtitle{font-size:12px;color:#777;}
#chat-box{flex:1;overflow-y:auto;padding:16px;}
.row{margin:10px 0;clear:both;}
.bubble{padding:10px 14px;border-radius:16px;max-width:70%;display:inline-block;}
.user .bubble{background:#2e9153;color:#fff;float:right;}
.bot .bubble{background:#eef2f3;color:#111;float:left;}
.timestamp{font-size:11px;color:#777;clear:both;}
#suggestions{padding:8px;display:flex;flex-wrap:wrap;gap:8px;}
#suggestions button{border:1px solid #ccc;background:#fff;border-radius:16px;padding:6px 12px;cursor:pointer;}
.input{padding:12px;border-top:1px solid #eee;display:flex;gap:8px;}
#user-input{flex:1;padding:10px;border:1px solid #ccc;border-radius:12px;}
#send-btn{background:#2e9153;color:#fff;border:none;border-radius:12px;padding:10px 16px;cursor:pointer;}
.side{width:240px;border-left:1px solid #eee;padding:12px;display:flex;flex-direction:column;}
.pill{display:inline-block;padding:6px 10px;background:#eef2f3;border-radius:16px;margin:2px 0;}
#reset-btn{margin-top:auto;background:#2e9153;color:#fff;border:none;padding:8px;border-radius:8px;cursor:pointer;}

/* typing indicator */
.typing{display:inline-flex;gap:4px;}
.dot{width:6px;height:6px;border-radius:50%;background:#999;animation:blink 1.4s infinite both;}
.dot:nth-child(2){animation-delay:.2s;}
.dot:nth-child(3){animation-delay:.4s;}
@keyframes blink{0%,80%,100%{opacity:.3;}40%{opacity:1;}}

/* cancel button */
#cancel-btn{display:none;margin:8px auto;padding:6px 12px;background:#d9534f;color:#fff;border:none;border-radius:8px;cursor:pointer;}
</style>
</head>
<body>
<div class="card">
  <div class="chat">
    <div class="header">
      <div class="avatar">K</div>
      <div><div class="title">Kai • Virtual Assistant</div><div class="subtitle">Usually replies in seconds</div></div>
    </div>
    <div id="chat-box"></div>
    <button id="cancel-btn">⏹ Cancel</button>
    <div id="suggestions"></div>
    <div class="input">
      <input id="user-input" type="text" placeholder="Type your message…" />
      <button id="send-btn">Send</button>
    </div>
  </div>
  <aside class="side">
    <h4>Need something quick?</h4>
    <span class="pill">Opening hours</span>
    <span class="pill">Make a booking</span>
    <span class="pill">Contact details</span>
    <button id="reset-btn">🔄 Start New Chat</button>
  </aside>
</div>

<script>
const API_URL = "https://chatbot-mvp-python.onrender.com/chat";
let SESSION_ID = localStorage.getItem("chat_session_id") || "web-" + Math.random().toString(36).slice(2,10);
localStorage.setItem("chat_session_id", SESSION_ID);

// language detection
const userLang = navigator.language || "en";
const lang = userLang.startsWith("fr") ? "fr"
           : userLang.startsWith("es") ? "es"
           : userLang.startsWith("de") ? "de"
           : userLang.startsWith("it") ? "it"
           : "en";
const translations = {
  en:{call:"📞 Call us",email:"📧 Email us",leave:"📝 Leave your number"},
  fr:{call:"📞 Appelez-nous",email:"📧 Envoyez-nous un email",leave:"📝 Laissez votre numéro"},
  es:{call:"📞 Llámanos",email:"📧 Envíanos un correo",leave:"📝 Deja tu número"},
  de:{call:"📞 Rufen Sie uns an",email:"📧 Schreiben Sie uns",leave:"📝 Hinterlassen Sie Ihre Nummer"},
  it:{call:"📞 Chiamaci",email:"📧 Scrivici un'email",leave:"📝 Lascia il tuo numero"}
};
const t = translations[lang] || translations.en;

// Chat helpers
const chatBox=document.getElementById("chat-box");
const cancelBtn=document.getElementById("cancel-btn");
let typingEl=null;
let abortController=null;

function addMessage(text,sender){
  if(typingEl){typingEl.remove();typingEl=null;}
  const row=document.createElement("div");
  row.className="row "+sender;
  const bubble=document.createElement("div");
  bubble.className="bubble";
  bubble.textContent=text;
  row.appendChild(bubble);
  const ts=document.createElement("div");
  ts.className="timestamp";
  ts.textContent=new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
  row.appendChild(ts);
  chatBox.appendChild(row);
  chatBox.scrollTop=chatBox.scrollHeight;
  saveHistory();
}

function showTyping(){
  if(typingEl) return;
  typingEl=document.createElement("div");
  typingEl.className="row bot";
  typingEl.innerHTML=`<div class="bubble"><span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span></div>`;
  chatBox.appendChild(typingEl);
  chatBox.scrollTop=chatBox.scrollHeight;
  cancelBtn.style.display="block";
}
function hideTyping(){
  if(typingEl){typingEl.remove();typingEl=null;}
  cancelBtn.style.display="none";
}

function saveHistory(){localStorage.setItem("chat_history", chatBox.innerHTML);}
function loadHistory(){const h=localStorage.getItem("chat_history");if(h) chatBox.innerHTML=h;}

function renderSuggestions(suggest=[]){
  const box=document.getElementById("suggestions");box.innerHTML="";
  suggest.forEach(txt=>{
    const b=document.createElement("button");
    b.textContent=txt;
    b.onclick=()=>{document.getElementById("user-input").value=txt;sendMessage();};
    box.appendChild(b);
  });
  if(suggest.includes("Call us")||suggest.includes("Email us")||suggest.includes("Leave your number")){
    const callBtn=document.createElement("button");callBtn.textContent=t.call;callBtn.onclick=()=>window.location.href="tel:+44123456789";box.appendChild(callBtn);
    const emailBtn=document.createElement("button");emailBtn.textContent=t.email;emailBtn.onclick=()=>window.location.href="mailto:info@example.com";box.appendChild(emailBtn);
    const leaveBtn=document.createElement("button");leaveBtn.textContent=t.leave;leaveBtn.onclick=()=>alert("📨 Please provide your number and we’ll call back.");box.appendChild(leaveBtn);
  }
}

async function sendMessage(){
  const input=document.getElementById("user-input");
  const text=input.value.trim();if(!text)return;
  addMessage(text,"user");input.value="";
  showTyping();

  abortController=new AbortController();
  try{
    const res=await fetch(API_URL+"?session_id="+SESSION_ID,{
      method:"POST",
      headers:{"Content-Type":"application/json","Accept-Language":userLang},
      body:JSON.stringify({message:text}),
      signal:abortController.signal
    });
    const data=await res.json();hideTyping();
    if(data.reply)addMessage(data.reply,"bot");
    renderSuggestions(data.suggest||[]);
  }catch(err){
    hideTyping();
    if(err.name==="AbortError"){addMessage("❌ Reply cancelled.","bot");}
    else{addMessage("⚠️ Could not reach the server.","bot");}
  }
}

document.getElementById("send-btn").addEventListener("click",sendMessage);
document.getElementById("user-input").addEventListener("keydown",e=>{if(e.key==="Enter")sendMessage();});
cancelBtn.addEventListener("click",()=>{if(abortController){abortController.abort();}hideTyping();});

// Intro
window.addEventListener("load",()=>{
  loadHistory();
  if(!localStorage.getItem("chat_history")){
    fetch(API_URL+"?session_id="+SESSION_ID,{
      method:"POST",
      headers:{"Content-Type":"application/json","Accept-Language":userLang},
      body:JSON.stringify({message:""})
    }).then(r=>r.json()).then(data=>{
      if(data.reply)addMessage(data.reply,"bot");
      renderSuggestions(data.suggest||[]);
    });
  }
});

// Reset
document.getElementById("reset-btn").addEventListener("click",()=>{
  localStorage.removeItem("chat_session_id");
  localStorage.removeItem("chat_history");
  location.reload();
});
</script>
</body>
</html>
